#!/bin/bash
# MEEF Complete Malware Processing Pipeline v2
# Extract â†’ Disassemble (CLEANED) â†’ Parse â†’ Generate IR
# Fixed version with parser-friendly disassembly output

set -e  # Exit on error

SAMPLES_DIR="samples/malicious"
OUTPUT_DIR="output/ir_results"
TEMP_DIR="temp_extracted"

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘        MEEF Processing Pipeline                          â•‘"
echo "â•‘           With Cleaned Disassembly Output                â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Safety check
echo "âš ï¸  WARNING: This will process REAL MALWARE samples!"
echo "   Make sure you are in an isolated VM environment."
echo ""
read -p "Continue? (yes/no): " confirm
if [ "$confirm" != "yes" ]; then
    echo "Aborted."
    exit 0
fi

# Check dependencies
echo ""
echo "[*] Checking dependencies..."
missing_deps=0

if ! command -v unzip &> /dev/null; then
    echo "  âœ— unzip not found (install: apt install unzip)"
    missing_deps=1
fi

if ! command -v objdump &> /dev/null; then
    echo "  âœ— objdump not found (install: apt install binutils)"
    missing_deps=1
fi

if ! command -v python3 &> /dev/null; then
    echo "  âœ— python3 not found"
    missing_deps=1
fi

if ! command -v grep &> /dev/null || ! command -v sed &> /dev/null; then
    echo "  âœ— grep/sed not found (should be pre-installed)"
    missing_deps=1
fi

if [ $missing_deps -eq 1 ]; then
    echo ""
    echo "[âœ—] Missing dependencies. Install with:"
    echo "    sudo apt install unzip binutils python3"
    exit 1
fi

echo "[âœ“] All dependencies found"

# Create directories
mkdir -p "$SAMPLES_DIR"
mkdir -p "$OUTPUT_DIR"
mkdir -p "$TEMP_DIR"

# Find all zip files
echo ""
echo "[*] Searching for malware archives in $SAMPLES_DIR..."
zip_files=($(find "$SAMPLES_DIR" -name "*.zip" -type f))

if [ ${#zip_files[@]} -eq 0 ]; then
    echo "[âœ—] No .zip files found in $SAMPLES_DIR"
    echo "    Download samples first using: python3 download_samples.py"
    exit 1
fi

echo "[âœ“] Found ${#zip_files[@]} archive(s)"

# Process each zip file
processed=0
failed=0

for zip_file in "${zip_files[@]}"; do
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "  Processing: $(basename "$zip_file")"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    # Extract basename for naming
    base_name=$(basename "$zip_file" .zip)
    extract_dir="$TEMP_DIR/$base_name"
    mkdir -p "$extract_dir"
    
    # Step 1: Extract (password: infected)
    echo "[1/4] Extracting archive..."
    if unzip -P infected -q "$zip_file" -d "$extract_dir" 2>/dev/null; then
        echo "  âœ“ Extracted successfully"
    else
        echo "  âœ— Extraction failed (trying 'malware' password)"
        if unzip -P malware -q "$zip_file" -d "$extract_dir" 2>/dev/null; then
            echo "  âœ“ Extracted with alternate password"
        else
            echo "  âœ— Could not extract"
            ((failed++))
            continue
        fi
    fi
    
    # Step 2: Find executable
    echo "[2/4] Locating executable..."
    exe_file=$(find "$extract_dir" -type f \( -name "*.exe" -o -name "*.dll" \) | head -1)
    
    if [ -z "$exe_file" ]; then
        echo "  âœ— No executable found"
        ((failed++))
        continue
    fi
    
    echo "  âœ“ Found: $(basename "$exe_file")"
    
    # Step 3: Disassemble with cleaning (FIXED VERSION)
    asm_file="$SAMPLES_DIR/${base_name}.asm"
    asm_file_tmp="${asm_file}.tmp"
    echo "[3/4] Disassembling & cleaning to $asm_file..."
    
    # Raw disassembly
    if objdump -d -M intel "$exe_file" > "$asm_file_tmp" 2>/dev/null; then
        echo "  â†’ Raw disassembly complete"
        
        # Clean it for parser
        echo "  â†’ Cleaning output for parser..."
        grep -E "^\s+[0-9a-f]+:" "$asm_file_tmp" | \
            sed -E 's/^\s+[0-9a-f]+:\s+[0-9a-f ]+\s+//' | \
            sed -E 's/\s+#.*//' | \
            sed -E 's/\s+$//' | \
            tr '[:lower:]' '[:upper:]' | \
            grep -v "^$" > "$asm_file"
        
        # Remove temp file
        rm -f "$asm_file_tmp"
        
        # Verify output
        asm_size=$(stat -c%s "$asm_file" 2>/dev/null || echo "0")
        asm_lines=$(wc -l < "$asm_file" 2>/dev/null || echo "0")
        
        if [ $asm_size -gt 100 ] && [ $asm_lines -gt 10 ]; then
            echo "  âœ“ Cleaned successfully ($asm_lines instructions, $(numfmt --to=iec-i --suffix=B $asm_size 2>/dev/null || echo "$asm_size bytes"))"
            
            # Show preview
            echo "  â†’ Preview (first 5 lines):"
            head -5 "$asm_file" | sed 's/^/     /'
        else
            echo "  âœ— Cleaning produced insufficient output ($asm_lines lines)"
            ((failed++))
            rm -f "$asm_file"
            continue
        fi
    else
        echo "  âœ— Disassembly failed"
        rm -f "$asm_file_tmp"
        ((failed++))
        continue
    fi
    
    # Step 4: Parse with MEEF
    ir_file="$OUTPUT_DIR/${base_name}_ir.json"
    echo "[4/4] Parsing with MEEF..."
    
    if ./src/cd_frontend/meef_parser "$asm_file" "$ir_file" > /dev/null 2>&1; then
        echo "  âœ“ IR generated: $ir_file"
        
        # Quick validation - check if IR has content
        if command -v jq &> /dev/null; then
            opcode_count=$(jq '.opcodes | length' "$ir_file" 2>/dev/null || echo "0")
            api_count=$(jq '.apis | length' "$ir_file" 2>/dev/null || echo "0")
            echo "  â†’ Found $opcode_count opcodes, $api_count APIs"
        fi
        
        ((processed++))
    else
        echo "  âš  Parsing had errors (IR may be partial)"
        # Still count as processed if IR file exists
        if [ -f "$ir_file" ]; then
            ((processed++))
        else
            ((failed++))
        fi
    fi
    
    # Clean up extracted files (keep .asm and .zip)
    rm -rf "$extract_dir"
done

# Cleanup temp directory
rm -rf "$TEMP_DIR"

# Summary
echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                   Processing Complete                    â•‘"
echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
echo "â•‘ Total archives:         ${#zip_files[@]}"
echo "â•‘ Successfully processed: $processed"
echo "â•‘ Failed:                 $failed"
echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
echo "â•‘ Outputs:"
echo "â•‘   ASM files:  $SAMPLES_DIR/*.asm"
echo "â•‘   IR files:   $OUTPUT_DIR/*_ir.json"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Update catalog
CATALOG_FILE="data/catalog.csv"
if [ $processed -gt 0 ]; then
    echo "[*] Updating catalog.csv..."
    
    # Create catalog if it doesn't exist
    if [ ! -f "$CATALOG_FILE" ]; then
        mkdir -p "$(dirname "$CATALOG_FILE")"
        echo "sha256,label,source,first_seen,local_path,ir_path,notes" > "$CATALOG_FILE"
        echo "  âœ“ Created catalog.csv"
    fi
    
    # Process each successful sample
    for asm_file in "$SAMPLES_DIR"/*.asm; do
        if [ -f "$asm_file" ]; then
            base_name=$(basename "$asm_file" .asm)
            ir_file="$OUTPUT_DIR/${base_name}_ir.json"
            
            # Check if IR file exists
            if [ -f "$ir_file" ]; then
                # Calculate SHA256 of asm file
                if command -v sha256sum &> /dev/null; then
                    sha256=$(sha256sum "$asm_file" | cut -d' ' -f1)
                elif command -v shasum &> /dev/null; then
                    sha256=$(shasum -a 256 "$asm_file" | cut -d' ' -f1)
                else
                    sha256="UNKNOWN_HASH"
                fi
                
                # Check if already in catalog
                if grep -q "$sha256" "$CATALOG_FILE" 2>/dev/null; then
                    continue  # Skip if already exists
                fi
                
                # Get timestamp
                timestamp=$(date '+%Y-%m-%d %H:%M:%S')
                
                # Extract behavioral notes from IR
                notes="none"
                if command -v jq &> /dev/null && [ -f "$ir_file" ]; then
                    behavior_flags=$(jq -r '.behavior | to_entries | map(select(.value == 1) | .key) | join(", ")' "$ir_file" 2>/dev/null)
                    notes="${behavior_flags:-none}"
                fi
                
                # Append to catalog
                echo "$sha256,malicious,MalwareBazaar,$timestamp,$asm_file,$ir_file,\"$notes\"" >> "$CATALOG_FILE"
            fi
        fi
    done
    
    echo "  âœ“ Catalog updated with $processed entries"
fi

echo ""
echo "[âœ“] Pipeline complete!"
echo "    Review results:"
echo "      - ASM files:  ls -lh $SAMPLES_DIR/*.asm"
echo "      - IR files:   ls -lh $OUTPUT_DIR"
echo "      - Catalog:    cat $CATALOG_FILE"
echo ""
echo "ðŸ’¡ Tip: Check a sample IR to verify opcodes and APIs were extracted:"
echo "    cat $OUTPUT_DIR/*.json | head -1 | jq ."
echo ""
